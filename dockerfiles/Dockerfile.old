FROM rocker/r-ver:3.6.3

WORKDIR /analysis

# Fix archived Debian repos
RUN sed -i 's|http://deb.debian.org|http://archive.debian.org|g' /etc/apt/sources.list && \
    sed -i 's|http://security.debian.org|http://archive.debian.org|g' /etc/apt/sources.list && \
    sed -i '/stretch-updates/d' /etc/apt/sources.list

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    libz-dev \
    && rm -rf /var/lib/apt/lists/*

# Use a dated RSPM snapshot compatible with R 3.6 (HTTP, not HTTPS)
ENV CRAN_REPO=http://packagemanager.posit.co/cran/2020-04-01

RUN R -e "install.packages('BiocManager', repos='${CRAN_REPO}')" && \
    R -e "options(repos = c(CRAN = '${CRAN_REPO}')); BiocManager::install(version = '3.10', ask = FALSE, update = FALSE)"

RUN R -e "options(repos = c(CRAN = '${CRAN_REPO}')); BiocManager::install('edgeR', ask = FALSE, update = FALSE)"

COPY bin/R/deg_analysis.R /home/analysis/
COPY inputs/count_data.csv /home/analysis/
COPY inputs/sample_info.csv /home/analysis/

RUN chmod +x /home/analysis/deg_analysis.R

CMD ["Rscript", "/home/analysis/deg_analysis.R"]